#!/bin/bash

rm ../$(basename $(pwd))*.tar.gz

[[ $(svnversion -c .) =~ ([0-9]+):?([0-9]*)([A-Z]*) ]]
LOW=${BASH_REMATCH[1]}
HIGH=${BASH_REMATCH[2]:-$LOW}
FLAGS=${BASH_REMATCH[3]:-''}

# [ $LOW -ne $HIGH ] && echo "- mixed revisions in local copy (low:high=$LOW:$HIGH)"
[ "$FLAGS" != "" ] && echo "- local copy has flags: $FLAGS"
echo "- highest revision in local copy: $HIGH"

sed -re "s/(^Version:[^-]*).+$/\1-$HIGH/" DESCRIPTION.template > DESCRIPTION

DATE=`LC_ALL=C svn info | awk '/^Last Changed Date:/ {print $4,$5}'`

now=$(date)
cat <<EOF > R/version.R
# Do not edit!  This file was autogenerated
#      by $0
#      on $now
#
# SVNVERSION as reported by svnversion at that point in time,

SVNVERSION <- "$HIGH"
SVNDATE <- "$DATE"

EOF

